<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moodify - Emotion-Based Music Player</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #000000, #2a0052, #9b59b6);
    --accent: #BA55D3;
    --text: #E6E6FA;
    --card-bg: rgba(26, 26, 26, 0.8);
    --shadow: 0 4px 20px rgba(186, 85, 211, 0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    height: 100vh;
    font-family: 'Poppins', sans-serif;
    background: var(--bg-gradient);
    color: var(--text);
    overflow: hidden;
    transition: all 0.5s ease;
  }

  .container {
    display: flex;
    height: 100%;
  }

  /* Sidebar */
  .sidebar {
    width: 280px;
    background: rgba(10, 10, 20, 0.9);
    backdrop-filter: blur(10px);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    border-right: 1px solid var(--accent);
    transition: all 0.4s ease;
    z-index: 10;
  }

  .sidebar.collapsed {
    width: 80px;
    padding: 20px 10px;
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    text-align: center;
    background: linear-gradient(135deg, #BA55D3, #FF69B4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .menu-btn {
    background: var(--card-bg);
    border: none;
    color: var(--text);
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
  }

  .menu-btn:hover { background: var(--accent); transform: translateY(-2px); }

  .playlist-card {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: var(--shadow);
  }

  .playlist-card:hover { transform: scale(1.05); }

  .playlist-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2px;
    height: 140px;
  }

  .playlist-grid img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .playlist-title {
    padding: 10px;
    text-align: center;
    font-weight: 600;
    background: rgba(0,0,0,0.5);
  }

  /* Main Content */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .top-bar {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(10, 10, 20, 0.7);
    backdrop-filter: blur(10px);
  }

  .search-box {
    background: rgba(255,255,255,0.1);
    border: none;
    padding: 12px 20px;
    border-radius: 30px;
    color: white;
    width: 300px;
    font-size: 15px;
  }

  .search-box::placeholder { color: #DDA0DD; }

  .emotion-btn {
    background: linear-gradient(135deg, #4B0082, #BA55D3);
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(186, 85, 211, 0.5);
    transition: all 0.3s;
  }

  .emotion-btn:hover { transform: scale(1.1); }

  .emotion-tag {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--accent);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
  }

  /* Player Area */
  .player-area {
    flex: 1;
    display: flex;
    padding: 20px;
    gap: 20px;
  }

  .visualizer {
    flex: 1;
    background: var(--card-bg);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .lyrics-box {
    width: 380px;
    background: rgba(186, 85, 211, 0.1);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 20px;
    overflow-y: auto;
    font-family: 'Playfair Display', serif;
    line-height: 2;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .lyrics-line {
    opacity: 0.5;
    transition: all 0.5s;
    margin: 8px 0;
    font-size: 18px;
  }

  .lyrics-line.active {
    opacity: 1;
    color: #FF00FF;
    font-weight: 700;
    font-size: 24px;
    text-shadow: 0 0 20px #FF00FF;
    transform: scale(1.05);
  }

  /* Bottom Player */
  .bottom-player {
    height: 90px;
    background: rgba(10, 10, 20, 0.9);
    backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    padding: 0 30px;
    border-top: 1px solid var(--accent);
  }

  .now-playing {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
  }

  .now-playing img {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    object-fit: cover;
  }

  .song-info h4 { margin: 0; font-size: 16px; }
  .song-info p { margin: 0; font-size: 12px; opacity: 0.7; }

  .controls {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .control-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 10px;
    border-radius: 50%;
    transition: all 0.3s;
  }

  .control-btn:hover {
    background: var(--accent);
    transform: scale(1.1);
  }

  .play-pause-btn {
    width: 50px;
    height: 50px;
    background: var(--accent);
    font-size: 28px;
  }

  .progress-container {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .progress-bar {
    -webkit-appearance: none;
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    outline: none;
  }

  .progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: #FF00FF;
    border-radius: 50%;
    cursor: pointer;
  }

  .time {
    font-size: 12px;
    opacity: 0.8;
    display: flex;
    justify-content: space-between;
  }

  /* Equalizer */
  .equalizer {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
  }

  .bar {
    width: 8px;
    height: 40px;
    background: var(--accent);
    border-radius: 4px;
    animation: pulse 1.5s infinite ease-in-out;
  }

  .bar:nth-child(2) { animation-delay: 0.1s; }
  .bar:nth-child(3) { animation-delay: 0.3s; }
  .bar:nth-child(4) { animation-delay: 0.5s; }
  .bar:nth-child(5) { animation-delay: 0.2s; }

  @keyframes pulse {
    0%, 100% { transform: scaleY(0.3); opacity: 0.6; }
    50% { transform: scaleY(1); opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container { flex-direction: column; }
    .sidebar { width: 100%; height: auto; flex-direction: row; padding: 15px; }
    .sidebar.collapsed { height: 60px; }
    .player-area { flex-direction: column; }
    .lyrics-box { width: 100%; height: 300px; }
    .search-box { width: 200px; }
  }
</style>
</head>
<body>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">Moodify</div>
    <button class="menu-btn" id="menuBtn">‚ò∞</button>
    
    <div class="playlist-card" id="currentPlaylist">
      <div class="playlist-grid" id="currentGrid"></div>
      <div class="playlist-title">Current Playlist</div>
    </div>

    <div class="playlist-card" id="likedSongs">
      <div class="playlist-grid" id="likedGrid"></div>
      <div class="playlist-title">‚ô• Liked Songs</div>
    </div>

    <button class="menu-btn" id="loginBtn">Login</button>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="top-bar">
      <input type="text" class="search-box" placeholder="Search songs..." id="searchInput">
      <button class="emotion-btn" id="emotionBtn">Loading...</button>
      <div class="emotion-tag" id="emotionTag">Detecting mood...</div>
    </div>

    <div class="player-area">
      <div class="visualizer" id="visualizer">
        <div class="equalizer">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>
      </div>

      <div class="lyrics-box" id="lyricsBox">
        <p>Play a song to see lyrics and beautiful visuals ‚ô™</p>
      </div>
    </div>

    <!-- Bottom Player -->
    <div class="bottom-player">
      <div class="now-playing">
        <img src="default_album.png" id="bottomThumb">
        <div class="song-info">
          <h4 id="songTitle">Not playing</h4>
          <p id="songArtist">Select a mood to begin</p>
        </div>
      </div>

      <div class="controls">
        <button class="control-btn">‚èÆ</button>
        <button class="control-btn play-pause-btn" id="playPauseBtn">‚ñ∂</button>
        <button class="control-btn">‚è≠</button>
        <button class="control-btn">‚ù§</button>
      </div>

      <div class="progress-container">
        <input type="range" class="progress-bar" id="progressBar" value="0">
        <div class="time">
          <span id="currentTime">0:00</span>
          <span id="duration">0:00</span>
        </div>
      </div>

      <div class="controls">
        <button class="control-btn">üîä</button>
        <button class="control-btn">üìú</button>
      </div>
    </div>
  </div>
</div>

<audio id="audioPlayer" preload="metadata"></audio>

<script>
  // Core elements
  const audio = document.getElementById('audioPlayer');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const progressBar = document.getElementById('progressBar');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const songTitle = document.getElementById('songTitle');
  const songArtist = document.getElementById('songArtist');
  const bottomThumb = document.getElementById('bottomThumb');
  const lyricsBox = document.getElementById('lyricsBox');
  const emotionBtn = document.getElementById('emotionBtn');
  const emotionTag = document.getElementById('emotionTag');
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menuBtn');

  const API_BASE = 'http://localhost:5001';
  let currentEmotion = 'calm';
  let isPlaying = false;

  const emotions = ['happy', 'sad', 'angry', 'calm', 'energetic'];
  const emojis = { happy: 'üòä', sad: 'üò¢', angry: 'üò†', calm: 'üòå', energetic: 'üí™' };

  // Toggle sidebar
  menuBtn.onclick = () => sidebar.classList.toggle('collapsed');

  // Emotion cycle
  emotionBtn.onclick = () => {
    const idx = emotions.indexOf(currentEmotion);
    currentEmotion = emotions[(idx + 1) % emotions.length];
    emotionBtn.textContent = emojis[currentEmotion];
    emotionTag.textContent = `Mood: ${currentEmotion.charAt(0).toUpperCase() + currentEmotion.slice(1)}`;
    fetch(`${API_BASE}/update-emotion`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ emotion: currentEmotion })
    }).then(() => playRandomSong());
  };

  // Play/Pause toggle
  playPauseBtn.onclick = () => {
    if (audio.src) {
      isPlaying ? audio.pause() : audio.play();
    }
  };

  // Update play/pause button
  audio.onplay = () => { playPauseBtn.textContent = '‚è∏'; isPlaying = true; };
  audio.onpause = () => { playPauseBtn.textContent = '‚ñ∂'; isPlaying = false; };

  // Progress bar
  audio.ontimeupdate = () => {
    if (audio.duration) {
      const progress = (audio.currentTime / audio.duration) * 100;
      progressBar.value = progress;
      currentTimeEl.textContent = formatTime(audio.currentTime);
      durationEl.textContent = formatTime(audio.duration);
      updateLyricsHighlight();
    }
  };

  progressBar.oninput = () => {
    audio.currentTime = (progressBar.value / 100) * audio.duration;
  };

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  async function playRandomSong() {
    const res = await fetch(`${API_BASE}/play-song?emotion=${currentEmotion}`);
    const song = await res.json();
    loadSong(song);
  }

  function loadSong(song) {
    audio.src = song.url;
    songTitle.textContent = song.title;
    songArtist.textContent = song.artist || 'Unknown Artist';
    bottomThumb.src = song.thumbnail || 'default_album.png';
    document.title = `${song.title} - Moodify`;
    audio.play();
    fetchLyrics(song.title, song.artist);
  }

  async function fetchLyrics(title, artist) {
    lyricsBox.innerHTML = '<p>Loading lyrics...</p>';
    try {
      const res = await fetch(`${API_BASE}/lyrics`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, artist })
      });
      const data = await res.json();
      if (data.lyrics) {
        const lines = data.lyrics.split('\n').filter(l => l.trim());
        lyricsBox.innerHTML = lines.map(line => `<div class="lyrics-line">${line}</div>`).join('');
      } else {
        lyricsBox.innerHTML = '<p style="opacity:0.6">No lyrics found</p>';
      }
    } catch (e) {
      lyricsBox.innerHTML = '<p style="opacity:0.6">Lyrics unavailable</p>';
    }
  }

  function updateLyricsHighlight() {
    const lines = lyricsBox.querySelectorAll('.lyrics-line');
    const currentTime = audio.currentTime;
    lines.forEach((line, i) => {
      const nextTime = i + 1 < lines.length ? (i + 1) * (audio.duration / lines.length) : audio.duration;
      if (currentTime >= i * (audio.duration / lines.length) && currentTime < nextTime) {
        line.classList.add('active');
        lyricsBox.scrollTop = line.offsetTop - lyricsBox.clientHeight / 3;
      } else {
        line.classList.remove('active');
      }
    });
  }

  // Init
  fetch(`${API_BASE}/current-emotion`).then(r => r.json()).then(data => {
    currentEmotion = data.emotion;
    emotionBtn.textContent = emojis[currentEmotion] || 'üéµ';
    emotionTag.textContent = `Mood: ${currentEmotion.charAt(0).toUpperCase() + currentEmotion.slice(1)}`;
  });

  // Auto-play first song
  setTimeout(() => {
    if (!audio.src) playRandomSong();
  }, 1000);
</script>

</body>
</html>