<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harmony - Emotion-Based Music Player</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
  :root {
    --bg-gradient: linear-gradient(135deg, #000000, #4B0082, #BA55D3);
    --text-color: #E6E6FA;
    --sub-text-color: #DDA0DD;
    --accent-gradient: linear-gradient(135deg, #4B0082, #9932CC);
    --hover-gradient: linear-gradient(135deg, #BA55D3, #DDA0DD);
    --active-gradient: linear-gradient(135deg, #FF00FF, #BA55D3);
    --disabled-gradient: linear-gradient(135deg, #4B0082, #9932CC);
    --label-gradient: linear-gradient(135deg, #4B0082, #9932CC, #BA55D3);
    --label-hover-gradient: linear-gradient(135deg, #6A1B9A, #BA55D3, #DDA0DD);
    --playlist-gradient: linear-gradient(135deg, #C71585, #FF69B4, #FFB6C1);
    --playlist-hover-gradient: linear-gradient(135deg, #DB7093, #FFB6C1, #FFD1DC);
    --progress-gradient: linear-gradient(135deg, #4B0082, #9932CC, #BA55D3);
    --progress-hover-gradient: linear-gradient(135deg, #6A1B9A, #BA55D3, #DDA0DD);
    --bar-left-gradient: linear-gradient(135deg, #1A1A1A, #4B0082, #BA55D3);
    --bar-middle-gradient: linear-gradient(135deg, #0A0A0A, #4B0082, #BA55D3);
    --bar-right-gradient: linear-gradient(135deg, #1A1A1A, #4B0082, #BA55D3);
    --bottom-gradient: linear-gradient(180deg, rgba(26, 26, 26, 0.9), rgba(75, 0, 130, 0.8));
    --bottom-dark-rgb: 26, 26, 26;
    --bottom-mid-rgb: 75, 0, 130;
    --shadow-rgb: 186, 85, 211;
    --border-color: #BA55D3;
    --active-text: #FF00FF;
    --lyrics-bg-alpha: 0.05;
    --lyrics-shadow-alpha: 0.4;
    --lyrics-border-alpha: 0.25;
    --lyrics-pulse-glow: rgba(255, 0, 255, 0.6);
    --lyrics-shadow: rgba(0,0,0,0.3);
    --text-shadow-color: rgba(0,0,0,0.5);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    height: 100%; width: 100%; overflow: hidden;
    font-family: 'Poppins', sans-serif;
    background: var(--bg-gradient);
    color: var(--text-color);
    text-shadow: 0 1px 3px var(--text-shadow-color);
  }
  /* [All your existing beautiful CSS remains unchanged - only minor tweaks below] */
  .bar-left {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @media (max-width: 768px) {
    .bar-left { position: fixed; left: -220px; width: 220px; z-index: 100; height: 100%; }
    .bar-left.expanded { left: 0; }
    .bar-right { display: none; }
    .upper-right { height: 100%; }
    .right-extra { height: 100%; }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
</head>
<body>
  <div id="theme-notice">Theme updated ♫</div>

  <div class="bar bar-left" id="leftSidebar">
    <button class="toggle-sidebar-button" id="toggleSidebarButton">☰ Menu</button>
    <div class="playlist-label">Current Playlist</div>
    <div class="current-playlist-placeholder" id="playlistButton1"></div>
    <div class="playlist-label">Liked Songs</div>
    <div class="liked-songs-placeholder" id="playlistButton2"></div>
    <button class="left-login-button logged-out" id="loginButton">Login</button>
  </div>

  <div class="right-section">
    <div class="upper-right">
      <div class="bar bar-middle">
        <div class="middle-top-row">
          <input type="text" placeholder="Search songs..." class="middle-search-bar" id="searchInput">
          <button class="camera-action-btn" id="cameraButton">Camera</button>
        </div>
        <div class="recently-played">
          <h3>Recently Played</h3>
          <div class="recent-list-horizontal" id="recentlyPlayedList"></div>
        </div>

        <div class="playlist-overlay" id="playlistOverlay">
          <div class="playlist-overlay-header">
            <h2 id="overlayTitle">Playlist</h2>
            <button class="close-playlist" id="closePlaylist">×</button>
          </div>
          <input type="text" placeholder="Search..." class="playlist-search-bar" id="playlistSearch">
          <div class="playlist-overlay-content" id="overlayContent"></div>
        </div>
      </div>

      <div class="bar bar-right">
        <div class="emotion-indicator" id="emotionIndicator">Emotion: Detecting...</div>
        <div class="right-bottom">
          <img src="default_album.png" class="player-thumbnail" id="playerThumbnail" crossorigin="anonymous">
          <div class="equalizer-container" id="equalizerContainer">
            <div class="equalizer-bar"></div><div class="equalizer-bar"></div><div class="equalizer-bar"></div>
            <div class="equalizer-bar"></div><div class="equalizer-bar"></div><div class="equalizer-bar"></div><div class="equalizer-bar"></div>
          </div>
        </div>
        <div class="right-extra">
          <div id="lyrics-container"></div>
        </div>
      </div>
    </div>

    <div class="bar bar-bottom">
      <div class="song-meta-container">
        <img src="default_album.png" class="song-thumbnail" id="bottomThumbnail">
        <div class="song-info">
          <div class="song-title" id="songTitle">No Song Playing</div>
          <div class="song-artist" id="songArtist">Unknown Artist</div>
        </div>
      </div>

      <div class="central-controls">
        <div class="player-controls">
          <button id="prevBtn" disabled>Prev</button>
          <button id="playBtn" disabled>Play</button>
          <button id="pauseBtn" disabled>Pause</button>
          <button id="nextBtn" disabled>Next</button>
          <button class="like-button" id="likeBtn" disabled>Heart</button>
        </div>
        <div class="progress-container">
          <input type="range" id="progressBar" min="0" max="100" value="0" disabled>
          <div class="time-display"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div>
        </div>
      </div>

      <div class="volume-controls">
        <button id="volumeBtn" disabled>Volume On</button>
        <div class="volume-slider-container" id="volumeSliderContainer">
          <input type="range" id="volumeSlider" min="0" max="100" value="70">
        </div>
      </div>
      <button class="lyrics-button" id="lyricsToggle" disabled>Lyrics</button>
    </div>
  </div>

  <audio id="audioPlayer" preload="metadata"></audio>

<script>
  const API_BASE = 'http://localhost:5001';
  const colorThief = new ColorThief();

  // State
  let currentEmotion = 'neutral';
  let currentSong = null;
  let currentPlaylist = [];
  let likedSongs = [];
  let recentlyPlayed = [];
  let isLoggedIn = false;
  let isSidebarExpanded = false;
  let isPollingEmotion = false;
  let emotionPollingInterval = null;
  let equalizerInterval = null;

  // DOM
  const elements = {
    leftSidebar: document.getElementById('leftSidebar'),
    toggleSidebarButton: document.getElementById('toggleSidebarButton'),
    cameraButton: document.getElementById('cameraButton'),
    emotionIndicator: document.getElementById('emotionIndicator'),
    playerThumbnail: document.getElementById('playerThumbnail'),
    bottomThumbnail: document.getElementById('bottomThumbnail'),
    songTitle: document.getElementById('songTitle'),
    songArtist: document.getElementById('songArtist'),
    audio: document.getElementById('audioPlayer'),
    playBtn: document.getElementById('playBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    nextBtn: document.getElementById('nextBtn'),
    prevBtn: document.getElementById('prevBtn'),
    likeBtn: document.getElementById('likeBtn'),
    progressBar: document.getElementById('progressBar'),
    currentTime: document.getElementById('currentTime'),
    totalTime: document.getElementById('totalTime'),
    volumeBtn: document.getElementById('volumeBtn'),
    volumeSlider: document.getElementById('volumeSlider'),
    volumeSliderContainer: document.getElementById('volumeSliderContainer'),
    lyricsContainer: document.getElementById('lyrics-container'),
    lyricsToggle: document.getElementById('lyricsToggle'),
    rightExtra: document.querySelector('.right-extra'),
    loginButton: document.getElementById('loginButton'),
    playlistButton1: document.getElementById('playlistButton1'),
    playlistButton2: document.getElementById('playlistButton2'),
    recentlyPlayedList: document.getElementById('recentlyPlayedList'),
    playlistOverlay: document.getElementById('playlistOverlay'),
    overlayTitle: document.getElementById('overlayTitle'),
    overlayContent: document.getElementById('overlayContent'),
    closePlaylist: document.getElementById('closePlaylist'),
  };

  // Utility
  const formatTime = (sec) => isNaN(sec) ? '0:00' : `${Math.floor(sec/60)}:${(Math.floor(sec%60)+'').padStart(2,'0')}`;

  const updateTheme = (img) => {
    if (!img.complete || !img.naturalWidth) return setTimeout(() => updateTheme(img), 100);
    try {
      const palette = colorThief.getPalette(img, 3);
      const main = [[0,0,0], [75,0,130], [186,85,211]];
      const blended = palette.map((c, i) => c.map((v,j) => Math.round(v*0.7 + main[i][j]*0.3)));
      document.documentElement.style.setProperty('--bg-gradient', `linear-gradient(135deg, rgb(${blended[0]}), rgb(${blended[1]}), rgb(${blended[2]}))`);
      document.documentElement.style.setProperty('--accent-gradient', `linear-gradient(135deg, rgb(${blended[1]}), rgb(${blended[2]}))`);
      document.getElementById('theme-notice').classList.add('show');
      setTimeout(() => document.getElementById('theme-notice').classList.remove('show'), 3000);
    } catch(e) {}
  };

  const showLyricsAnimation = () => {
    elements.lyricsContainer.innerHTML = `<div class="music-box"></div>`;
    const box = elements.lyricsContainer.querySelector('.music-box');
    for(let i=0; i<15; i++){
      const note = document.createElement('div'); note.className='note'; note.textContent=['Note','Note','Note','Note','Note','Note','Drum','Guitar'][i%8];
      note.style.left = Math.random()*100+'%'; note.style.animationDelay = Math.random()*4+'s'; note.style.fontSize = 20+Math.random()*20+'px';
      box.appendChild(note);
    }
  };

  const playSong = async (song, autoPlay = true) => {
    currentSong = song;
    elements.audio.src = song.url || song.cloud_url;
    elements.playerThumbnail.src = elements.bottomThumbnail.src = song.thumbnail || 'default_album.png';
    elements.songTitle.textContent = song.title || 'Unknown';
    elements.songArtist.textContent = song.artist || 'Unknown Artist';
    updateTheme(elements.playerThumbnail);
    elements.likeBtn.classList.toggle('liked', likedSongs.some(s => s.cloud_url === song.url));

    if (autoPlay) {
      elements.audio.play().catch(() => {});
      startEqualizer();
    } else {
      stopEqualizer();
    }

    // Fetch lyrics
    try {
      const res = await fetch(`${API_BASE}/lyrics`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:song.title, artist:song.artist})});
      const data = await res.json();
      if (data.lyrics) {
        elements.lyricsContainer.innerHTML = data.lyrics.split('\n').map(l => `<span class="lyrics-line">${l}</span>`).join('');
      } else throw 1;
    } catch {
      elements.lyricsContainer.innerHTML = '<div style="opacity:0.6;font-style:italic">Lyrics not available</div>';
    }
    showLyricsAnimation();
  };

  const startEqualizer = () => {
    document.querySelectorAll('.equalizer-bar').forEach((bar, i) => {
      bar.classList.add('active');
      bar.style.animationDelay = i*0.1+'s';
    });
  };
  const stopEqualizer = () => document.querySelectorAll('.equalizer-bar').forEach(b => b.classList.remove('active'));

  // Camera + Emotion Detection (Improved)
  elements.cameraButton.addEventListener('click', async () => {
    if (!isLoggedIn) return;
    elements.audio.pause();
    stopEqualizer();
    elements.emotionIndicator.textContent = 'Camera Starting...';

    if (emotionPollingInterval) clearInterval(emotionPollingInterval);

    try {
      const res = await fetch(`${API_BASE}/start-camera`, {method: 'POST'});
      const data = await res.json();
      if (data.success) {
        isPollingEmotion = true;
        elements.emotionIndicator.textContent = 'Camera Look into camera...';
        emotionPollingInterval = setInterval(async () => {
          try {
            const r = await fetch(`${API_BASE}/current-emotion`);
            const d = await r.json();
            if (d.emotion && d.emotion !== 'null' && d.emotion !== currentEmotion) {
              clearInterval(emotionPollingInterval);
              currentEmotion = d.emotion;
              elements.emotionIndicator.textContent = `Emotion: ${currentEmotion}`;
              await fetch(`${API_BASE}/clear-recently-played?emotion=${currentEmotion}`, {method:'POST'});
              await Promise.all([loadCurrent09Playlist(), loadRecentlyPlayed()]);
              startPlayback();
            }
          } catch {}
        }, 1200);
      }
    } catch (e) {
      elements.emotionIndicator.textContent = 'Camera Camera failed';
    }
  });

  const startPlayback = async () => {
    try {
      const res = await fetch(`${API_BASE}/play-song?emotion=${currentEmotion}`);
      const song = await res.json();
      playSong(song);
    } catch {}
  };

  // Login / Init
  const init = async () => {
    try {
      const res = await fetch(`${API_BASE}/current-emotion`);
      if (res.status === 401) throw 401;
      const {emotion} = await res.json();
      currentEmotion = emotion;
      elements.emotionIndicator.textContent = `Emotion: ${emotion || 'neutral'}`;
      isLoggedIn = true;
      elements.loginButton.textContent = 'Logout';
      elements.loginButton.classList.add('logged-in');
      Object.values(elements).forEach(el => { if (el && el.disabled !== undefined) el.disabled = false; });
      await Promise.all([loadCurrentPlaylist(), loadRecentlyPlayed(), loadLikedSongs()]);
      startPlayback();
    } catch (e) {
      if (e === 401) elements.loginButton.onclick = () => location.href = '15.html';
    }
  };

  // Load data functions (simplified)
  const loadCurrentPlaylist = async () => { /* ... same as before ... */ };
  const loadRecentlyPlayed = async () => { /* ... */ };
  const loadLikedSongs = async () => { /* ... */ };

  // Event Listeners (core)
  elements.playBtn.onclick = () => elements.audio.play();
  elements.pauseBtn.onclick = () => elements.audio.pause();
  elements.nextBtn.onclick = async () => { const res = await fetch(`${API_BASE}/play-next`, {method:'POST', body:JSON.stringify({current_song_id: currentSong?.id})}); playSong(await res.json()); };
  elements.audio.ontimeupdate = () => {
    if (!isNaN(elements.audio.duration)) {
      const prog = (elements.audio.currentTime / elements.audio.duration) * 100;
      elements.progressBar.value = prog;
      elements.currentTime.textContent = formatTime(elements.audio.currentTime);
      elements.totalTime.textContent = formatTime(elements.audio.duration);
    }
  };

  // Mobile sidebar toggle
  elements.toggleSidebarButton.onclick = () => {
    isSidebarExpanded = !isSidebarExpanded;
    elements.leftSidebar.classList.toggle('expanded', isSidebarExpanded);
  };

  window.addEventListener('resize', () => {
    if (window.innerWidth > 768 && isSidebarExpanded) {
      isSidebarExpanded = false;
      elements.leftSidebar.classList.remove('expanded');
    }
  });

  init();
</script>
</body>
</html>